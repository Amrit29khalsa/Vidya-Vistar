<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Whiteboard for LMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .draggable { cursor: move; }
        canvas { border: 2px solid #4CAF50; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="flex justify-center items-center h-screen">
        <div class="max-w-4xl w-full bg-white shadow-lg rounded-lg p-8">
            <h1 class="text-3xl font-semibold mb-8 text-center">Collaborative Whiteboard</h1>
            <div class="border border-green-300 rounded-lg mb-6 p-4 relative">
                <div class="flex justify-center items-center">
                    <canvas id="whiteboard" width="700" height="500"></canvas>
                </div>
                <div class="absolute top-0 right-0 p-2">
                    <button id="clearBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Clear</button>
                    <button id="eraserBtn" class="ml-2 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Eraser</button>
                    <button id="shareBtn" class="ml-2 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">Share</button>
                </div>
            </div>
            <div class="flex justify-between items-center mb-4">
                <div class="relative flex items-center">
                    <label for="toolSelect" class="mr-2">Tool:</label>
                    <select id="toolSelect" class="px-3 py-2 bg-gray-200 rounded-lg appearance-none">
                        <option value="pen">Pen</option>
                        <option value="line">Line</option>
                        <option value="rectangle">Rectangle</option>
                        <option value="circle">Circle</option>
                        <option value="text">Text</option>
                    </select>
                </div>
                <div>
                    <label for="colorPicker" class="mr-2">Color:</label>
                    <input type="color" id="colorPicker" value="#000000" class="h-10 w-10">
                    <label for="lineWidth" class="ml-4 mr-2">Width:</label>
                    <input type="range" id="lineWidth" min="1" max="20" value="5" class="w-20">
                </div>
                <div>
                    <button id="saveBtn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">Save</button>
                    <input type="file" id="imageInput" accept="image/*" class="hidden">
                    <button id="imageBtn" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">Insert Image</button>
                </div>
            </div>
            <div id="textInput" class="mb-4 hidden">
                <input type="text" id="textBox" class="border border-gray-300 rounded-lg p-2 w-full" placeholder="Enter text">
            </div>
            <div id="shareLink" class="mb-4 hidden">
                <input type="text" id="shareLinkInput" class="border border-gray-300 rounded-lg p-2 w-full" readonly>
                <button id="copyLinkBtn" class="ml-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Copy Link</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        const canvas = document.getElementById('whiteboard');
        const ctx = canvas.getContext('2d');
        const toolSelect = document.getElementById('toolSelect');
        const colorPicker = document.getElementById('colorPicker');
        const lineWidth = document.getElementById('lineWidth');
        const clearBtn = document.getElementById('clearBtn');
        const eraserBtn = document.getElementById('eraserBtn');
        const saveBtn = document.getElementById('saveBtn');
        const imageBtn = document.getElementById('imageBtn');
        const imageInput = document.getElementById('imageInput');
        const textInput = document.getElementById('textInput');
        const textBox = document.getElementById('textBox');
        const shareBtn = document.getElementById('shareBtn');
        const shareLink = document.getElementById('shareLink');
        const shareLinkInput = document.getElementById('shareLinkInput');
        const copyLinkBtn = document.getElementById('copyLinkBtn');

        let drawing = false;
        let currentTool = 'pen';
        let startX, startY;
        let whiteboardId = new URLSearchParams(window.location.search).get('whiteboardId') || 'default';
        let username = new URLSearchParams(window.location.search).get('username') || 'User' + Math.floor(Math.random() * 1000);

        // WebSocket connection
        const socket = io('http://localhost:3000', {
            query: { whiteboardId, username }
        });

        // Drawing setup
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';

        // Event listeners
        toolSelect.addEventListener('change', () => {
            currentTool = toolSelect.value;
            textInput.classList.toggle('hidden', currentTool !== 'text');
        });

        colorPicker.addEventListener('change', () => {
            ctx.strokeStyle = colorPicker.value;
            ctx.fillStyle = colorPicker.value;
        });

        lineWidth.addEventListener('change', () => {
            ctx.lineWidth = lineWidth.value;
        });

        canvas.addEventListener('mousedown', (e) => {
            drawing = true;
            startX = e.offsetX;
            startY = e.offsetY;
            if (currentTool === 'text') {
                textInput.classList.remove('hidden');
                textBox.focus();
            } else {
                ctx.beginPath();
                ctx.moveTo(startX, startY);
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!drawing) return;
            const x = e.offsetX;
            const y = e.offsetY;
            draw(x, y);
            socket.emit('draw', { tool: currentTool, startX, startY, x, y, color: ctx.strokeStyle, lineWidth: ctx.lineWidth });
        });

        canvas.addEventListener('mouseup', () => {
            drawing = false;
            ctx.closePath();
        });

        canvas.addEventListener('mouseout', () => {
            drawing = false;
            ctx.closePath();
        });

        textBox.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                ctx.font = `${lineWidth.value * 2}px Arial`;
                ctx.fillText(textBox.value, startX, startY);
                socket.emit('draw', { tool: 'text', text: textBox.value, x: startX, y: startY, color: ctx.strokeStyle, lineWidth: ctx.lineWidth });
                textBox.value = '';
                textInput.classList.add('hidden');
            }
        });

        clearBtn.addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            socket.emit('clear');
        });

        eraserBtn.addEventListener('click', () => {
            ctx.strokeStyle = '#FFFFFF';
            ctx.fillStyle = '#FFFFFF';
            currentTool = 'pen';
        });

        saveBtn.addEventListener('click', () => {
            const dataURL = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.href = dataURL;
            link.download = 'whiteboard.png';
            link.click();
        });

        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        ctx.drawImage(img, 0, 0, 200, 200);
                        socket.emit('draw', { tool: 'image', dataURL: img.src, x: 0, y: 0, width: 200, height: 200 });
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        imageBtn.addEventListener('click', () => {
            imageInput.click();
        });

        shareBtn.addEventListener('click', () => {
            shareLinkInput.value = `${window.location.origin}${window.location.pathname}?whiteboardId=${whiteboardId}&username=${username}`;
            shareLink.classList.remove('hidden');
        });

        copyLinkBtn.addEventListener('click', () => {
            shareLinkInput.select();
            document.execCommand('copy');
            alert('Link copied to clipboard!');
        });

        // WebSocket events
        socket.on('draw', (data) => {
            ctx.strokeStyle = data.color;
            ctx.fillStyle = data.color;
            ctx.lineWidth = data.lineWidth;
            drawRemote(data);
        });

        socket.on('clear', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        });

        // Drawing function
        function draw(x, y) {
            if (currentTool === 'pen') {
                ctx.lineTo(x, y);
                ctx.stroke();
            } else if (currentTool === 'line') {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.beginPath();
                ctx.moveTo(startX, startY);
                ctx.lineTo(x, y);
                ctx.stroke();
            } else if (currentTool === 'rectangle') {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.beginPath();
                ctx.rect(startX, startY, x - startX, y - startY);
                ctx.stroke();
            } else if (currentTool === 'circle') {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.beginPath();
                const radius = Math.sqrt(Math.pow(x - startX, 2) + Math.pow(y - startY, 2));
                ctx.arc(startX, startY, radius, 0, 2 * Math.PI);
                ctx.stroke();
            }
        }

        function drawRemote(data) {
            ctx.beginPath();
            if (data.tool === 'pen') {
                ctx.moveTo(data.startX, data.startY);
                ctx.lineTo(data.x, data.y);
                ctx.stroke();
            } else if (data.tool === 'line') {
                ctx.moveTo(data.startX, data.startY);
                ctx.lineTo(data.x, data.y);
                ctx.stroke();
            } else if (data.tool === 'rectangle') {
                ctx.rect(data.startX, data.startY, data.x - data.startX, data.y - data.startY);
                ctx.stroke();
            } else if (data.tool === 'circle') {
                const radius = Math.sqrt(Math.pow(data.x - data.startX, 2) + Math.pow(data.y - data.startY, 2));
                ctx.arc(data.startX, data.startY, radius, 0, 2 * Math.PI);
                ctx.stroke();
            } else if (data.tool === 'text') {
                ctx.font = `${data.lineWidth * 2}px Arial`;
                ctx.fillText(data.text, data.x, data.y);
            } else if (data.tool === 'image') {
                const img = new Image();
                img.src = data.dataURL;
                img.onload = () => {
                    ctx.drawImage(img, data.x, data.y, data.width, data.height);
                };
            }
            ctx.closePath();
        }
    </script>
</body>
</html>